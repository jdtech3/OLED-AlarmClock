#include <string>

#include <Arduino.h>

#include <Wire.h>
#include <ESP8266WiFi.h>
#include <BlynkSimpleStream.h>
#include <ezTime.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_GFX.h>

#include "settings.hpp"

// Init stuff
ADC_MODE(ADC_VCC);                                   // for boot-up Vcc display
Adafruit_SSD1306 display(128, 64, &Wire, -1);        // height, width, lib, reset pin
WiFiClient blynkWiFiClient;     // WiFi client for the Blynk features
Timezone tz;    // eztime timezone obj
char buf[24];   // text output buffer

const unsigned char jLogoBitmap [] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x02, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x06,
    0x00, 0xfe, 0x40, 0x00, 0x00, 0x0e, 0x00, 0xfe, 0x60, 0x00, 0x00, 0x1e, 0x00, 0xfe, 0x70, 0x00,
    0x00, 0x3e, 0x00, 0xfe, 0x78, 0x00, 0x00, 0x7e, 0x00, 0xfe, 0x7c, 0x00, 0x00, 0xfe, 0x00, 0xfe,
    0x7e, 0x00, 0x00, 0xfe, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0xfe, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0xfc,
    0x00, 0xfe, 0x7f, 0x00, 0x00, 0xf8, 0x00, 0xfe, 0x3f, 0x00, 0x00, 0xf0, 0x00, 0xfe, 0x1f, 0x00,
    0x00, 0xf8, 0x00, 0xfe, 0x3f, 0x00, 0x00, 0xfc, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0xfe, 0x00, 0xfe,
    0x7f, 0x00, 0x00, 0xfe, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0xfe, 0x00, 0xfe, 0x7e, 0x00, 0x00, 0x7e,
    0x40, 0xfe, 0x7c, 0x00, 0x00, 0x3e, 0x60, 0xfe, 0x78, 0x00, 0x00, 0x1e, 0x70, 0xfe, 0x70, 0x00,
    0x00, 0x0e, 0x78, 0xfe, 0x60, 0x00, 0x00, 0x06, 0x7c, 0xfe, 0x40, 0x00, 0x00, 0x02, 0x7e, 0xfe,
    0x00, 0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00,
    0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfe, 0x00, 0x00,
    0x00, 0x00, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8,
    0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Beep!
void beep() {
    analogWrite(15, 128);
    delay(50);
    analogWrite(15, 0);
}


// --- BLYNK METHODS ---

// Display Vcc
BLYNK_READ(V3) {
    Blynk.virtualWrite(V3, system_get_vdd33() / 1000.0);
}

// Reset
BLYNK_WRITE(V99) {
    ESP.reset();
}

void setup() {
    if (settings::DEBUG) beep();

    display.begin(SSD1306_SWITCHCAPVCC, 0x3C);              // I2C address
    display.display(); display.clearDisplay();              // clear splash screen
    display.drawBitmap(40, 12, jLogoBitmap, 48, 48, WHITE); // display logo
    display.display();

    // Set initial display settings
    display.setTextSize(1);
    display.setTextColor(WHITE, BLACK);
    display.setCursor(0, 0);

    if (settings::DEBUG) {
        // Display voltage
        sprintf(buf, "Vcc: %.2fV", system_get_vdd33() / 1000.0);
        display.println(buf);
    }

    // Connect to WiFi
    WiFi.mode(WIFI_STA);
    WiFi.begin(settings::WIFI_SSID, settings::WIFI_PASSWORD);

    // Display WiFi connecting
    display.setCursor(0, 0);
    display.println(String(F("Connecting to: ")) + settings::WIFI_SSID);
    while (WiFi.status() != WL_CONNECTED) {
        display.print('.');
        display.display();
        delay(250);
    }

    // Init ezTime
    waitForSync();
    tz.setLocation(settings::TIMEZONE);
    setInterval(120);

    // Init Blynk
    blynkWiFiClient.stop();
    blynkWiFiClient.connect(BLYNK_DEFAULT_DOMAIN, BLYNK_DEFAULT_PORT);
    Blynk.begin(blynkWiFiClient, settings::BLYNK_AUTH_TOKEN);
    Blynk.virtualWrite(V2, WiFi.SSID());    // push SSID to Blynk

    // Display IP, Vcc, freq
    if (settings::DEBUG) {
        display.clearDisplay();
        display.setCursor(0, 48);
        display.println(F("Connected."));
        display.println(String("IP: ") + WiFi.localIP().toString());
    }

    display.display();  // display all of above

    delay(1000);

    display.clearDisplay(); display.display();  // clear splash stuff
}

void loop() {
    // Run ezTime events
    events();

    // Run Blynk events
    Blynk.run();

    // Display time
    if (secondChanged()) {
        // Print date
        display.setCursor(56, 0);
        display.setTextSize(1);
        display.println(tz.dateTime("M j, Y"));

        // Print time
        display.setCursor(0, 24);
        display.setTextSize(2);
        display.print(tz.dateTime("h:i:s"));
        display.setTextSize(1);
        display.println(tz.dateTime(" A"));

        display.display();  // update display
    }
}
